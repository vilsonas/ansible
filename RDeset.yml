---
- name: Install ESET RD Sensor on Linux
  hosts: linux_servers
  become: yes
  tasks:

    # Install required dependencies including expect
    - name: Install required dependencies
      package:
        name:
          - wget
          - curl
          - expect
          - python3-pip
          - systemd
        state: present

    # Download the ESET RD Sensor installation script
    - name: Download ESET RD Sensor installation script
      get_url:
        url: "https://download.eset.com/com/eset/apps/business/era/rdsensor/latest/rdsensor-linux-x86_64.sh"
        dest: "/tmp/rdsensor-linux-x86_64.sh"
        mode: '0755'

    # Ensure the installation script is executable
    - name: Ensure script is executable
      file:
        path: /tmp/rdsensor-linux-x86_64.sh
        mode: '0755'

    # Run the installation script, simulate Ctrl+C to stop the rules prompt, then accept agreements
    - name: Run the installation script and accept prompts
      expect:
        command: bash /tmp/rdsensor-linux-x86_64.sh
        responses:
          # Press Ctrl+C to stop reading rules (simulated by sending '\003' which is the Ctrl+C signal)
          "Do you accept the license? [y/N]": "y"
          "Do you want to participate in the Product improvement program? [Y/n]": "y"
          "Do you want to continue with the installation? [y/N]": "y"
        timeout: 600
        matches:
          - "Do you accept the license? [y/N]"
          - "Do you want to participate in the Product improvement program? [Y/n]"
          - "Do you want to continue with the installation? [y/N]"
        stop_signal: '\003'  # This simulates pressing <Ctrl+C> to stop reading the rules

    # Print installation log output for debugging
    - name: Print installation log
      debug:
        var: install_output.stdout_lines

    # Ensure ESET RD Sensor service is running
    - name: Ensure ESET RD Sensor service is running
      systemd:
        name: rdsensor
        state: started
        enabled: yes
      ignore_errors: yes
