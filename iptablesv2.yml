---
- name: Konfiguruojam iptables su states
  hosts: test
  become: true
  tasks:
    - name: Flush existing iptables rules
      iptables:
        flush: yes

    - name: Allow incoming (SSH, HTTP, HTTPS, ZABBIX AGENT)
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: "{{ item }}"
        match: state
        state: NEW,ESTABLISHED
        jump: ACCEPT
      loop:
        - 22
        - 80
        - 443
        - 10050

    - name: Log incoming ICMP echo requests (type 8)
      iptables:
        chain: INPUT
        protocol: icmp
        match: icmp
        icmp_type: echo-request
        jump: LOG
        log_prefix: "ICMP Echo Request: "
        log_level: 4

    - name: Log incoming ICMP echo replies (type 0)
      iptables:
        chain: INPUT
        protocol: icmp
        match: icmp
        icmp_type: echo-reply
        jump: LOG
        log_prefix: "ICMP Echo Reply: "
        log_level: 4

    - name: Allow incoming ICMP echo reply (type 0)
      iptables:
        chain: INPUT
        protocol: icmp
        match: icmp
        icmp_type: echo-reply
        jump: ACCEPT

    - name: Block echo request (ICMP type 8)
      iptables:
        chain: INPUT
        protocol: icmp
        match: icmp
        icmp_type: echo-request
        jump: DROP

    - name: Allow outgoing traffic (SSH, HTTP, HTTPS, syslog)
      iptables:
        chain: OUTPUT
        protocol: tcp
        destination_port: "{{ item }}"
        match: state
        state: NEW,ESTABLISHED
        jump: ACCEPT
      loop:
        - 22
        - 80
        - 443
        - 5614

    - name: Allow outgoing traffic (syslog udp)
      iptables:
        chain: OUTPUT
        protocol: udp
        destination_port: "{{ item }}"
        match: state
        state: NEW,ESTABLISHED
        jump: ACCEPT
      loop:
        - 514

    - name: Drop all įeinantį trafficą
      iptables:
        chain: INPUT
        jump: DROP

    - name: Drop all išeinantį trafficą
      iptables:
        chain: OUTPUT
        jump: DROP

    - name: Log dropped packets
      iptables:
        chain: INPUT
        jump: LOG
        log_prefix: "Dropped Packet in: "
        log_level: 4

    - name: Log dropped packets
      iptables:
        chain: OUTPUT
        jump: LOG
        log_prefix: "Dropped Packet out: "
        log_level: 4

    - name: Save iptables rules
      command: netfilter-persistent save
